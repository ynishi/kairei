name: Task Organization Analysis

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'src/**'
      - 'tests/**'

jobs:
  analyze-changes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze changes
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get the PR details
            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: context.issue.number
            });
            
            // Get changed files
            const files = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: context.issue.number
            });
            
            // Define component patterns
            const components = {
              'tokenizer': /src\/tokenizer/,
              'parser': /src\/parser/,
              'type_checker': /src\/type_checker/,
              'runtime': /src\/runtime/,
              'system': /src\/system/
            };
            
            // Analyze which components are affected
            const affectedComponents = new Set();
            for (const file of files.data) {
              for (const [component, pattern] of Object.entries(components)) {
                if (pattern.test(file.filename)) {
                  affectedComponents.add(component);
                }
              }
            }
            
            // If multiple core components are affected, suggest splitting
            if (affectedComponents.size > 1) {
              const componentsList = Array.from(affectedComponents).join(', ');
              
              // Create knowledge base entry
              const knowledgeEntry = {
                title: `è¤‡æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å¤‰æ›´: ${componentsList}`,
                description: `
# ç¯„å›²æ‹¡å¤§ã®æ¤œçŸ¥

## å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
${Array.from(affectedComponents).map(c => `- ${c}`).join('\n')}

## åˆ†æ
- å½“åˆã®æƒ³å®šã‚ˆã‚Šç¯„å›²ãŒæ‹¡å¤§ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
- è¤‡æ•°ã®ã‚³ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¤‰æ›´ãŒåŠã‚“ã§ã„ã¾ã™

## æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
1. ã‚¿ã‚¹ã‚¯ã®åˆ†å‰²ã‚’æ¤œè¨
2. å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã”ã¨ã«ç‹¬ç«‹ã—ãŸPRã‚’ä½œæˆ
3. ä¾å­˜é–¢ä¿‚ã®æ˜ç¢ºåŒ–

## å½±éŸ¿ç¯„å›²
${Array.from(affectedComponents).map(c => `### ${c}\n- å¤‰æ›´ã®æ¦‚è¦\n- ä»–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã®ä¾å­˜é–¢ä¿‚`).join('\n\n')}
                `,
                tags: ['scope-expansion', 'multiple-components', ...Array.from(affectedComponents)]
              };
              
              // Add comment to PR
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.issue.number,
                body: `# ğŸ”„ ã‚¿ã‚¹ã‚¯ç¯„å›²ã®æ‹¡å¤§æ¤œçŸ¥

è¤‡æ•°ã®ã‚³ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¤‰æ›´ãŒåŠã‚“ã§ã„ã¾ã™ï¼š
${Array.from(affectedComponents).map(c => `- ${c}`).join('\n')}

## ææ¡ˆ ğŸ“
é–¢é€£ã‚¿ã‚¹ã‚¯ã‚’åˆ†å‰²ã—ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ

### åˆ†å‰²æ¡ˆ
${Array.from(affectedComponents).map(c => `1. ${c}ã®å¤‰æ›´`).join('\n')}

### ãƒ¡ãƒªãƒƒãƒˆ
- ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã—ã‚„ã™ããªã‚Šã¾ã™
- å„å¤‰æ›´ã®å½±éŸ¿ç¯„å›²ãŒæ˜ç¢ºã«ãªã‚Šã¾ã™
- ãƒ†ã‚¹ãƒˆãŒåŠ¹ç‡çš„ã«ãªã‚Šã¾ã™

ã“ã®åˆ†æçµæœã¯ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã«è¨˜éŒ²ã•ã‚Œã¾ã—ãŸã€‚`
              });
              
              // Add label to PR
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: context.issue.number,
                labels: ['scope-expanded']
              });
            }

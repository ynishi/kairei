name: Scope Expansion Detection

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'src/**'
      - 'tests/**'

jobs:
  detect-scope-expansion:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze scope expansion
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get PR and issue details
            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: context.issue.number
            });
            
            // Check for docs/design reference in PR
            const hasDesignDocRef = pr.data.body.toLowerCase().includes('docs/design');
            if (!hasDesignDocRef) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.issue.number,
                body: `# âš ï¸ è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã®ç¢ºèª

docs/design (Single Source of Truth) ã¸ã®å‚ç…§ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚
å®Ÿè£…å‰ã«å¿…ãšè¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

## ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
1. docs/design ã®é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª
2. PRã®èª¬æ˜ã«å‚ç…§ã—ãŸè¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¨˜è¼‰
3. è¨­è¨ˆã¨ã®æ•´åˆæ€§ã‚’ç¢ºèª`
              });
              return;
            }
            
            // Extract issue number from PR body if it references one
            const issueMatch = pr.data.body.match(/#(\d+)/);
            if (!issueMatch) return;
            
            const issueNumber = issueMatch[1];
            const issue = await github.rest.issues.get({
              owner,
              repo,
              issue_number: parseInt(issueNumber)
            });
            
            // Get changed files
            const files = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: context.issue.number
            });
            
            // Analyze complexity indicators
            const indicators = {
              fileCount: files.data.length,
              totalChanges: files.data.reduce((acc, file) => acc + file.changes, 0),
              componentsAffected: new Set(
                files.data
                  .map(f => f.filename.split('/')[1])
                  .filter(c => ['tokenizer', 'parser', 'type_checker', 'runtime', 'system'].includes(c))
              ).size
            };
            
            // Define thresholds for scope expansion
            const thresholds = {
              fileCount: 5,
              totalChanges: 200,
              componentsAffected: 2
            };
            
            // Check if scope has expanded
            const hasExpanded = 
              indicators.fileCount > thresholds.fileCount ||
              indicators.totalChanges > thresholds.totalChanges ||
              indicators.componentsAffected > thresholds.componentsAffected;
            
            if (hasExpanded) {
              // Create knowledge base entry
              const knowledgeEntry = {
                title: `ã‚¹ã‚³ãƒ¼ãƒ—æ‹¡å¤§æ¤œçŸ¥: Issue #${issueNumber}`,
                description: `
# ã‚¹ã‚³ãƒ¼ãƒ—æ‹¡å¤§ã®åˆ†æ

## å…ƒã®Issue
${issue.data.title}

## æ‹¡å¤§æŒ‡æ¨™
- å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${indicators.fileCount} (é–¾å€¤: ${thresholds.fileCount})
- ç·å¤‰æ›´è¡Œæ•°: ${indicators.totalChanges} (é–¾å€¤: ${thresholds.totalChanges})
- å½±éŸ¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ•°: ${indicators.componentsAffected} (é–¾å€¤: ${thresholds.componentsAffected})

## åˆ†æ
- å½“åˆã®Issueã‚ˆã‚Šç¯„å›²ãŒæ‹¡å¤§ã—ã¦ã„ã¾ã™
- è¤‡æ•°ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¤‰æ›´ãŒåŠã‚“ã§ã„ã¾ã™
- å¤‰æ›´é‡ãŒäºˆæƒ³ã‚’è¶…ãˆã¦ã„ã¾ã™

## æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
1. ç¾åœ¨ã®å¤‰æ›´ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼
2. ã‚¿ã‚¹ã‚¯ã®åˆ†å‰²æ¤œè¨
3. è¿½åŠ Issueä½œæˆã®æ¤œè¨

## å½±éŸ¿ç¯„å›²
${files.data.map(f => `- ${f.filename}: ${f.changes} è¡Œã®å¤‰æ›´`).join('\n')}
                `,
                tags: ['scope-expansion', 'complexity-increase', `issue-${issueNumber}`]
              };
              
              // Add comment to PR
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.issue.number,
                body: `# ğŸ” ã‚¹ã‚³ãƒ¼ãƒ—æ‹¡å¤§æ¤œçŸ¥

å…ƒã®Issue #${issueNumber} ã‹ã‚‰ã€å®Ÿè£…ç¯„å›²ãŒæ‹¡å¤§ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## åˆ†æçµæœ
- å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${indicators.fileCount} ãƒ•ã‚¡ã‚¤ãƒ«
- ç·å¤‰æ›´è¡Œæ•°: ${indicators.totalChanges} è¡Œ
- å½±éŸ¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ•°: ${indicators.componentsAffected}

## ææ¡ˆ
1. ç¾åœ¨ã®å¤‰æ›´ã‚’ä¸€æ™‚åœæ­¢
2. ä»¥ä¸‹ã®æ¤œè¨ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼š
   - ã‚¿ã‚¹ã‚¯ã®åˆ†å‰²
   - è¿½åŠ Issueã®ä½œæˆ
   - å®Ÿè£…ç¯„å›²ã®è¦‹ç›´ã—

ã“ã®åˆ†æçµæœã¯ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã«è¨˜éŒ²ã•ã‚Œã¾ã—ãŸã€‚`
              });
              
              // Add label to PR
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: context.issue.number,
                labels: ['scope-expanded']
              });
            }
